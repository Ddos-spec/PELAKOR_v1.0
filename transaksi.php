<?php session_start(); include 'connect-db.php'; include 'functions/functions.php'; if(isset($_SESSION["login-admin"]) && isset($_SESSION["admin"])){ $login = "Admin"; $query = mysqli_query($connect, "SELECT * FROM transaksi"); } else if(isset($_SESSION["login-agen"]) && isset($_SESSION["agen"])){ $login = "Agen"; $idAgen = $_SESSION["agen"]; $query = mysqli_query($connect, "SELECT * FROM transaksi WHERE id_agen = $idAgen"); } else if(isset($_SESSION["login-pelanggan"]) && isset($_SESSION["pelanggan"])){ $login = "Pelanggan"; $idPelanggan = $_SESSION["pelanggan"]; $query = mysqli_query($connect, "SELECT * FROM transaksi WHERE id_pelanggan = $idPelanggan"); } else { echo "<script>window.location = 'login.php';</script>"; } ?> <!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <?php include "headtags.html"; ?> <title>Transaksi - <?= $login ?></title> </head> <body> <?php include 'header.php'; ?> <div class="row"> <h3 class="header col s12 light center">Riwayat Transaksi</h3> <div class="col s10 offset-s1"> <table border="1" cellpadding="10" class="responsive-table centered"> <tr> <th>Kode Transaksi</th> <?php if($login != "Pelanggan") echo "<th>Agen</th>"; ?> <?php if($login != "Agen") echo "<th>Pelanggan</th>"; ?> <th>Total Item</th> <th>Berat</th> <th>Jenis</th> <th>Total Bayar</th> <th>Status Pembayaran</th> <th>Tanggal Pesan</th> <th>Tanggal Selesai</th> <th>Rating</th> <th>Komentar</th> </tr> <?php while($transaksi = mysqli_fetch_assoc($query)): ?> <tr> <td><?= $transaksi["kode_transaksi"] ?></td> <?php if($login != "Pelanggan"): $agenQuery = mysqli_query($connect, "SELECT nama_laundry FROM agen WHERE id_agen = ".$transaksi["id_agen"]); $agenRow = mysqli_fetch_assoc($agenQuery); ?> <td><?= $agenRow["nama_laundry"] ?></td> <?php endif; ?> <?php if($login != "Agen"): $pelQuery = mysqli_query($connect, "SELECT nama FROM pelanggan WHERE id_pelanggan = ".$transaksi["id_pelanggan"]); $pelRow = mysqli_fetch_assoc($pelQuery); ?> <td><?= $pelRow["nama"] ?></td> <?php endif; ?> <td><?= $transaksi["total_item"] ?></td> <td><?= $transaksi["berat"] ?? '-' ?></td> <td><?= $transaksi["jenis"] ?></td> <td><?= "Rp " . number_format(getHargaPaket($transaksi["jenis"], $transaksi["id_agen"]), 0, ',', '.') ?></td> <td><?= "Rp " . number_format(getTotalPerItem($transaksi["item_type"] ?? '', $transaksi["id_agen"]), 0, ',', '.') ?></td> <td><?= "Rp " . number_format(calculateTotalHarga($transaksi), 0, ',', '.') ?></td> <td><?= $transaksi["tgl_mulai"] ?></td> <td><?= $transaksi["tgl_selesai"] ?></td> <td><?= $transaksi["rating"] ?></td> <td><?= $transaksi["komentar"] ?></td> </tr> <?php endwhile; ?> </table> </div> </div> <?php include 'footer.php'; ?> <?php // Gunakan fungsi yang sama seperti di status.php function getHargaPaket($jenis, $idAgen) { global $connect; $q = mysqli_query($connect, "SELECT harga FROM harga WHERE id_agen = $idAgen AND jenis = '$jenis'"); $row = mysqli_fetch_assoc($q); return $row['harga'] ?? 0; } function getPerItemPrice($item, $idAgen) { global $connect; $q = mysqli_query($connect, "SELECT harga FROM harga WHERE id_agen = $idAgen AND jenis = '$item'"); $row = mysqli_fetch_assoc($q); return $row['harga'] ?? 0; } function getTotalPerItem($itemType, $idAgen) { $total = 0; $items = explode(', ', $itemType); foreach($items as $it) { if(trim($it) == "") continue; preg_match('/([^(]+)\((\d+)\)/', $it, $matches); if(count($matches)==3) { $item = strtolower(trim($matches[1])); $qty = (int)$matches[2]; $price = getPerItemPrice($item, $idAgen); $total += $price * $qty; } } return $total; } function calculateTotalHarga($transaksi) { $paket = getHargaPaket($transaksi["jenis"], $transaksi["id_agen"]); $totalPerItem = getTotalPerItem($transaksi["item_type"] ?? '', $transaksi["id_agen"]); return $paket + $totalPerItem; } ?> </body> </html>